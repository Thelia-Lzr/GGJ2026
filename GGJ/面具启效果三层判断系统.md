# 面具启效果三层判断系统

## 设计理念

将面具启效果的可用性判断分为三个层次，实现更精确的控制：

```
HasActivateAbility (静态) 
    ↓ 
CanUseActivateThisRound (每回合重置)
    ↓
CanUseActivateNow() (动态判断)
    ↓
显示黄圈
```

---

## 三层判断详解

### 第一层：HasActivateAbility（是否有启效果方法）

**类型**: `bool` 属性（只读）

**含义**: 面具是否定义了启效果方法

**设置时机**: 构造函数中通过参数 `hasActivateAbility` 设置

**特点**: 
- 静态，不会改变
- 在面具创建时就确定

**代码**:
```csharp
public bool HasActivateAbility { get; protected set; }

public Mask(..., bool hasActivateAbility = false)
{
    HasActivateAbility = hasActivateAbility;
}
```

**示例**:
- `MaskCandleHandler`: `HasActivateAbility = true`
- `MaskAgony`: `HasActivateAbility = false`

---

### 第二层：CanUseActivateThisRound（本回合是否还能使用）

**类型**: `bool` 属性（可读写）

**含义**: 本回合是否还没有使用过启效果

**重置时机**: 
- 每回合开始时设为 `true`（如果HasActivateAbility为true）
- 使用启效果后立即设为 `false`
- 回合结束时设为 `false`
- 切换到新面具时设为 `true`（如果是玩家回合）

**特点**:
- 动态，每回合重置
- 用于限制"每回合只能使用一次"

**代码**:
```csharp
public bool CanUseActivateThisRound { get; set; }

// RoundManager回合开始
if (currentActiveTeam == Team.Player && unit.CurrentMask != null)
{
    unit.CurrentMask.CanUseActivateThisRound = unit.CurrentMask.HasActivateAbility;
}

// 使用后
mask.CanUseActivateThisRound = false;
```

---

### 第三层：CanUseActivateNow()（当前是否满足使用条件）

**类型**: `virtual bool` 方法

**含义**: 当前时刻是否满足所有使用条件

**检查内容**:
1. **基础检查**（Mask基类）：
   - HasActivateAbility == true
   - CanUseActivateThisRound == true
   - !IsBroken（面具未破损）

2. **额外条件**（子类重写）：
   - 耐久度要求（如：≤4）
   - 其他特殊条件

**特点**:
- 实时判断
- 子类可以重写添加自定义条件
- 只有此方法返回true时才显示黄圈

**代码**:
```csharp
// Mask基类
public virtual bool CanUseActivateNow()
{
    if (!HasActivateAbility || !CanUseActivateThisRound || IsBroken)
        return false;
    
    return true;
}

// MaskCandleHandler子类
public override bool CanUseActivateNow()
{
    if (!base.CanUseActivateNow())
        return false;
    
    // 额外条件：耐久≤4
    return CurrentHealth <= 4;
}
```

---

## 使用示例

### 秉烛人的面具

**描述**: 启：若面具耐久≤4，对所有敌人造成3点群体伤害，然后回复此面具3点耐久。

**三层判断**:

1. **HasActivateAbility = true**
   - 构造函数中设置

2. **CanUseActivateThisRound**
   - 回合开始时 = true
   - 使用一次后 = false
   - 保证每回合只能用一次

3. **CanUseActivateNow()**
   ```csharp
   public override bool CanUseActivateNow()
   {
       if (!base.CanUseActivateNow())  // 检查基础条件
           return false;
       
       return CurrentHealth <= 4;  // 额外条件：耐久≤4
   }
   ```

**场景示例**:

| 耐久 | 回合状态 | HasActivate | ThisRound | Now() | 显示黄圈? |
|------|---------|-------------|-----------|-------|----------|
| 3    | 开始    | ?           | ?         | ?     | **是** ? |
| 3    | 已使用  | ?           | ?         | ?     | 否 ?     |
| 8    | 开始    | ?           | ?         | ?     | 否 ?     |
| 0    | 开始    | ?           | ?         | ?     | 否 ?     |

---

## 完整流程

### 1. 回合开始流程

```
RoundManager.OnRoundStart()
  ↓
if (Team.Player && mask != null)
  ↓
mask.CanUseActivateThisRound = mask.HasActivateAbility
  ↓
if (mask.CanUseActivateNow())  // 三层判断
  ↓
unit.ShowActivateCircle()  // 显示黄圈
```

### 2. 使用启效果流程

```
玩家右键点击黄圈
  ↓
ActivateCircle.TriggerActivate()
  ↓
检查 mask.CanUseActivateNow()
  ↓
mask.CanUseActivateThisRound = false  // 标记本回合已使用
  ↓
执行 mask.Activate(controller)
  ↓
Destroy(黄圈)
```

### 3. 切换面具流程

```
玩家切换面具
  ↓
UnitController.SwitchMask()
  ↓
mask.CanUseActivateThisRound = true  // 重置标记
  ↓
if (mask.CanUseActivateNow())
  ↓
unit.ShowActivateCircle()  // 显示黄圈
```

### 4. 回合结束流程

```
RoundManager.OnRoundEnd()
  ↓
if (Team.Player && mask != null)
  ↓
mask.CanUseActivateThisRound = false
  ↓
unit.HideActivateCircle()
```

---

## 为新面具添加启效果

### 步骤1：在构造函数中启用

```csharp
public MaskYourMask() : base(
    maskName: "你的面具",
    // ...其他参数...
    hasActivateAbility: true)  // ← 设置为true
{
}
```

### 步骤2：实现Activate方法

```csharp
public override IEnumerator Activate(UnitController controller)
{
    // 实现你的效果逻辑
    Debug.Log("触发启效果！");
    
    // 记得调用base
    yield return base.Activate(controller);
}
```

### 步骤3：（可选）重写CanUseActivateNow

如果有额外条件（如耐久、资源等），重写此方法：

```csharp
public override bool CanUseActivateNow()
{
    // 先检查基础条件
    if (!base.CanUseActivateNow())
        return false;
    
    // 添加你的额外条件
    if (CurrentHealth > 5)
        return false;  // 例如：只有耐久≤5时可用
    
    return true;
}
```

---

## 调试信息

系统会输出以下日志：

### 回合开始
```
[RoundManager] 步骤1: 单位回合开始逻辑
  → BattleUnit1 显示ActivateCircle
```

### 使用启效果
```
[ActivateCircle] EventSystem检测到右键点击
[ActivateCircle] 触发 秉烛人的面具 的启效果
[MaskCandleHandler] 面具耐久 ≤ 4，触发群体伤害效果！
```

### 条件不满足
```
[UnitController] 戴上新面具 秉烛人的面具，但不满足启效果条件
```

---

## 注意事项

1. **HasActivateAbility 必须手动设置**
   - 即使重写了Activate方法，如果构造函数中没有传 `hasActivateAbility: true`，启效果也不会启用

2. **CanUseActivateNow() 需要重写**
   - 如果有额外条件（如耐久要求），必须重写此方法
   - 否则只会检查基础条件

3. **每回合只能使用一次**
   - `CanUseActivateThisRound` 保证了每回合只能使用一次启效果
   - 即使切换到同一个面具也只能用一次

4. **黄圈显示逻辑**
   - 只有 `CanUseActivateNow()` 返回 `true` 时才显示黄圈
   - 这意味着即使有启效果，不满足条件也看不到黄圈

5. **面具破损**
   - 面具破损后（CurrentHealth ≤ 0），启效果自动不可用
   - `CanUseActivateNow()` 会返回 `false`

---

## 相关文件

- `Assets\Scripts\Masks\Mask.cs` - 基类实现
- `Assets\Scripts\Masks\MaskType\MaskCandleHandler.cs` - 示例：带条件的启效果
- `Assets\Scripts\BattleUnit\RoundManager.cs` - 回合管理
- `Assets\Scripts\BattleUnit\UnitController.cs` - 切换面具逻辑
- `Assets\Scripts\Drag\ForUnits\ActivateCircle.cs` - 黄圈交互
- `Assets\Scripts\ActionCommand.cs` - 命令验证
