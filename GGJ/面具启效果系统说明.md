# 面具启效果(Activate)系统说明文档

## 功能概述
面具启效果系统允许玩家在回合开始时，通过右键点击带有黄色圆圈特效的角色来触发面具的特殊效果。此系统包括自动检测面具是否有重写Activate方法、视觉提示、交互处理和性能优化。

## 核心组件

### 1. Mask基类 (Assets\Scripts\Masks\Mask.cs)
#### 新增属性
- `HasActivateAbility` (bool): 标识该面具是否有启效果（手动指定）
- `CanUseActivate` (bool): 标识当前回合是否可以使用启效果

#### 构造函数变更
```csharp
public Mask(string maskName, int switchCost, int maxHealth, int atk, int atkCost, string description = "", bool hasActivateAbility = false)
{
    MaskName = maskName;
    Description = description;
    SwitchCost = switchCost;
    MaxHealth = maxHealth;
    CurrentHealth = MaxHealth;
    Atk = atk;
    AtkCost = atkCost;
    
    // 手动指定是否有启效果
    HasActivateAbility = hasActivateAbility;
    CanUseActivate = false;
    
    if (hasActivateAbility)
    {
        Debug.Log($"[Mask] {maskName} 启效果可用");
    }
    
    // ... 加载sprite等其他代码 ...
}
```

**注意**：面具类需要在构造函数中手动传入 `hasActivateAbility: true` 参数来启用启效果。

### 2. ActionType枚举 (Assets\Scripts\ActionCommand.cs)
#### 新增枚举值
```csharp
public enum ActionType
{
    Attack,
    SwitchMask,
    ActivateMask  // 新增：面具启效果
}
```

#### ActionCommand验证更新
```csharp
public bool IsValid()
{
    // ... 原有验证 ...
    
    if (ActionType == ActionType.ActivateMask)
    {
        if (MaskData == null || !MaskData.CanUseActivate)
            return false;
    }
    
    return true;
}
```

### 3. BattleUnit (Assets\Scripts\BattleUnit\BattleUnit.cs)
#### 新增字段
```csharp
private GameObject currentActivateCircle;
```

#### 新增方法
```csharp
// 显示黄圈特效
public void ShowActivateCircle()
{
    if (currentMask == null || !currentMask.CanUseActivate)
        return;
    
    if (currentActivateCircle != null)
        return;
    
    currentActivateCircle = new GameObject("ActivateCircle");
    currentActivateCircle.transform.SetParent(transform);
    currentActivateCircle.transform.localPosition = Vector3.zero;
    
    ActivateCircle circle = currentActivateCircle.AddComponent<ActivateCircle>();
    circle.Initialize(this);
}

// 隐藏黄圈特效
public void HideActivateCircle()
{
    if (currentActivateCircle != null)
    {
        Destroy(currentActivateCircle);
        currentActivateCircle = null;
    }
}
```

### 4. ActivateCircle (Assets\Scripts\Drag\ForUnits\ActivateCircle.cs)
黄圈交互组件，负责：
- 渲染半透明黄色圆圈
- 脉冲动画效果（透明度在0.4-0.6之间变化）
- 检测右键点击
- 触发面具的Activate效果

#### 核心功能
```csharp
public void Initialize(BattleUnit unit)
{
    // 设置视觉效果
    spriteRenderer.color = new Color(1f, 1f, 0f, 0.5f);
    spriteRenderer.sortingOrder = 2;
    
    // 添加碰撞体用于点击检测
    CircleCollider2D collider = gameObject.AddComponent<CircleCollider2D>();
    collider.radius = 1.5f;
    
    // 注册到管理器
    ActivateCircleManager.Instance?.RegisterCircle(this);
    
    // 启动脉冲动画
    StartCoroutine(PulseAnimation());
}

private void TriggerActivate()
{
    // 创建ActivateMask的ActionCommand
    ActionCommand activateCommand = new ActionCommand(
        boundUnit.Controller, 
        ActionType.ActivateMask)
    {
        ResourceCost = 0,
        MaskData = mask
    };
    
    // 提交到AnimationHandler执行
    animHandler.SubmitAction(
        mask.Activate(boundUnit.Controller), 
        activateCommand, 
        boundUnit.Controller);
    
    // 销毁黄圈
    Destroy(gameObject);
}
```

### 5. ActivateCircleManager (Assets\Scripts\Managers\ActivateCircleManager.cs)
单例管理器，负责：
- 统一管理所有ActivateCircle实例
- 有序更新以节省性能（每帧只更新部分圆圈）
- 批量清理黄圈

#### 性能优化
```csharp
private int circlesPerFrame = 2; // 每帧只更新2个圆圈

private void Update()
{
    // 有序循环更新
    int updatedCount = 0;
    while (updatedCount < circlesPerFrame && activeCircles.Count > 0)
    {
        // 更新当前索引的圆圈
        currentUpdateIndex++;
        updatedCount++;
    }
}
```

### 6. RoundManager (Assets\Scripts\BattleUnit\RoundManager.cs)
#### 回合开始时
```csharp
foreach (var unit in activeTeamUnits)
{
    // 玩家回合开始时，重置面具的CanUseActivate并显示黄圈
    if (currentActiveTeam == Team.Player && unit.CurrentMask != null)
    {
        unit.CurrentMask.CanUseActivate = unit.CurrentMask.HasActivateAbility;
        if (unit.CurrentMask.CanUseActivate)
        {
            unit.ShowActivateCircle();
        }
    }
}
```

#### 回合结束时
```csharp
foreach (var unit in currentTeamUnits)
{
    // 玩家回合结束时，将所有CanUseActivate设为false并移除黄圈
    if (currentActiveTeam == Team.Player)
    {
        if (unit.CurrentMask != null)
        {
            unit.CurrentMask.CanUseActivate = false;
        }
        unit.HideActivateCircle();
    }
}
```

### 7. UnitController (Assets\Scripts\BattleUnit\UnitController.cs)
#### 处理ActivateMask动作
```csharp
protected virtual IEnumerator GetActionCoroutine(ActionCommand command)
{
    switch (command.ActionType)
    {
        // ... 其他case ...
        
        case ActionType.ActivateMask:
            if (command.MaskData != null)
            {
                Debug.Log($"[UnitController] 执行面具启效果: {command.MaskData.MaskName}");
                yield return command.MaskData.Activate(this);
            }
            break;
    }
}
```

#### 切换面具时刷新启效果
```csharp
public virtual bool SwitchMask(Mask newMask, int cost)
{
    // ... 切换面具逻辑 ...
    
    // 如果是玩家回合且新面具有启效果，立即刷新黄圈（即使这回合用过）
    if (RoundManager.Instance != null && 
        RoundManager.Instance.CurrentActiveTeam == Team.Player &&
        boundUnit.UnitTeam == Team.Player &&
        currentMask.HasActivateAbility)
    {
        // 先移除旧黄圈
        boundUnit.HideActivateCircle();
        
        // 刷新启效果状态并显示新黄圈
        currentMask.CanUseActivate = true;
        boundUnit.ShowActivateCircle();
        
        Debug.Log($"[UnitController] 戴上新面具 {currentMask.MaskName}，刷新启效果黄圈");
    }
    
    return true;
}
```

## 使用流程

### 1. 为面具实现Activate方法并启用
在面具类中重写Activate方法，并在构造函数中传入 `hasActivateAbility: true`：

```csharp
public class MaskCandleHandler : Mask
{
    public MaskCandleHandler() : base(
        maskName: "秉烛人的面具",
        switchCost: 1,
        maxHealth: 11,
        atk: 5,
        atkCost: 1,
        description: "启：若面具耐久≤4，对所有敌人造成3点群体伤害，然后回复此面具3点耐久。",
        hasActivateAbility: true)  // 重要：必须设置为true才能启用启效果
    {
    }

    public override IEnumerator Activate(UnitController controller)
    {
        if (CurrentHealth <= 4)
        {
            // 对所有敌人造成3点伤害
            Team enemyTeam = controller.BoundUnit.UnitTeam == Team.Player ? Team.Enemy : Team.Player;
            List<BattleUnit> enemies = GetEnemyUnits(enemyTeam);
            
            foreach (var enemy in enemies)
            {
                if (enemy.IsAlive())
                {
                    enemy.ApplyHealthChange(-3);
                }
            }
            
            // 恢复3点耐久
            RepairMask(3);
        }
        
        yield return base.Activate(controller);
    }
}
```

**重要提示**：
- 即使重写了Activate方法，如果构造函数中不传入 `hasActivateAbility: true`，启效果也不会被启用
- 这种手动指定的方式避免了使用反射，提高了性能
- 确保description中说明了启效果的功能

### 2. 自动识别
- 当构造函数传入 `hasActivateAbility: true` 时，`HasActivateAbility`属性会被设置为`true`
- 系统会在日志中输出：`[Mask] {MaskName} 启效果可用`

### 3. 玩家回合开始
- RoundManager检测所有玩家单位的面具
- 如果面具的`HasActivateAbility`为true，则：
  - 设置`CanUseActivate = true`
  - 在单位周围显示黄色圆圈

### 4. 玩家交互
- **使用启效果**：玩家右键点击带有黄圈的角色
- **切换面具**：玩家在回合中切换到有启效果的面具时，会立即刷新黄圈
  - ActivateCircle触发TriggerActivate方法
  - 创建ActivateMask类型的ActionCommand
  - 提交到AnimationHandler执行
  - 执行完成后销毁黄圈
- **重要**：切换面具会重置启效果的使用状态，即使该回合已经使用过启效果

### 5. 回合结束
- RoundManager将所有`CanUseActivate`设为false
- 移除所有黄圈特效

## 性能优化

### 1. 有序更新
- ActivateCircleManager每帧只更新部分圆圈
- 避免同时更新大量圆圈造成性能问题

### 2. 协程动画
- 使用协程实现脉冲动画
- 每帧一次yield return null，保持流畅

### 3. 自动清理
- 回合结束时自动清理所有黄圈
- OnDestroy时自动从管理器注销

## 调试信息

系统会输出以下日志：
- `[Mask] {MaskName} 启效果可用` - 构造时设置hasActivateAbility=true时输出
- `[BattleUnit] 为 {unitName} 创建ActivateCircle` - 显示黄圈
- `[UnitController] 戴上新面具 {MaskName}，刷新启效果黄圈` - 切换面具时刷新
- `[ActivateCircle] 触发 {MaskName} 的启效果` - 玩家点击触发
- `[UnitController] 执行面具启效果: {MaskName}` - 执行效果
- `[ActivateCircleManager] 注册/注销ActivateCircle` - 管理器操作

## 注意事项

1. **手动启用**：即使重写了Activate方法，也必须在构造函数中传入 `hasActivateAbility: true` 才能启用启效果
2. **切换面具刷新**：在玩家回合中切换到有启效果的面具时，会立即刷新黄圈并重置使用状态，即使该回合已经使用过其他面具的启效果
3. **两种圆圈独立**：
   - **ActionCircle（攻击圈）**: 用于拖拽攻击敌人，由`UnitController`管理
   - **ActivateCircle（黄圈）**: 用于右键触发启效果，由`BattleUnit`管理
   - 两者完全独立，可以同时存在，互不影响
   - GameObject名称不同：`ActionCircle` vs `ActivateCircle_ForMaskAbility`
4. **Sprite资源**：ActivateCircle会尝试加载`Resources/Sprites/Circle`，如果不存在会尝试使用Unity内置的`UI/Skin/Knob`
5. **点击检测**：使用CircleCollider2D和OnMouseOver进行点击检测，确保场景中有摄像机
6. **AnimationHandler**：系统依赖AnimationHandler来执行协程，确保场景中存在
7. **单例**：ActivateCircleManager使用单例模式，会自动DontDestroyOnLoad
8. **性能优化**：移除了反射检测，采用手动指定方式，提高运行时性能

## 扩展建议

1. **可视化增强**：可以添加粒子效果、更复杂的动画
2. **音效**：在触发启效果时播放音效
3. **UI提示**：显示面具启效果的说明文字
4. **多次使用**：可以修改为每回合多次使用（修改CanUseActivate逻辑）
5. **消耗资源**：可以让启效果消耗行动点或其他资源
